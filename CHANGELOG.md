# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Added

- Initial repository scaffolding
- .NET solution skeleton with PantryDeskApp, PantryDeskCore, and PantryDeskSeeder projects
- Repository documentation (README.md, TODO.md, CHANGELOG.md, LICENSE.md)
- .gitignore for .NET/Visual Studio
- `.editorconfig` for consistent C# code formatting
- `AppConfig` class in PantryDeskCore for data folder configuration (defaults to `C:\ProgramData\PantryDesk\`)
- **Phase 1: Database schema and data access layer**
  - SQLite database schema with 5 tables: `config`, `households`, `service_events`, `pantry_days`, `auth_roles`
  - Database migration system with schema version tracking (currently version 1)
  - `DatabaseManager` for connection management and database initialization
  - `DatabaseMigrator` for schema creation and version management
  - Data models: `Household`, `ServiceEvent`, `PantryDay`, `AuthRole`
  - Repository classes with full CRUD operations:
    - `HouseholdRepository` - Create, read, update, soft delete
    - `ServiceEventRepository` - Create and query methods
    - `PantryDayRepository` - Full CRUD operations
    - `AuthRoleRepository` - Role authentication with password hashing
    - `ConfigRepository` - Schema version and app version management
  - `PasswordHasher` using PBKDF2 with 100,000 iterations for secure password storage
  - All SQL queries use parameterized statements (SQL injection protection)
  - Centralized SQL statements in `Sql.cs` class
- **Phase 2: Authentication (Entry/Admin)**
  - `SessionManager` class for tracking current logged-in role
  - `PermissionChecker` helper class for Admin-only feature enforcement
  - `AuthRoleRepository.HasAnyRoles()` method to check if roles exist in database
  - `InitialSetupForm` for first-time password configuration (Entry and Admin roles)
    - Password validation (minimum 8 characters, confirmation required)
    - Warning if Entry and Admin passwords are identical
    - Stores passwords as salted hashes (no default passwords)
  - `LoginForm` for user authentication with role selection
    - Role dropdown (Entry/Admin)
    - Password verification using existing `AuthRoleRepository`
    - Error handling for invalid credentials
  - `ChangePasswordForm` for Admin to change role passwords
    - Requires current password verification
    - Validates new password (8+ characters, confirmation match)
    - Prevents reusing current password
    - Success/error feedback
  - Application startup flow: Initial Setup → Login → Main Form
  - Form1 updated with Admin menu (visible only to Admin users)
  - Form1 title displays current logged-in role
  - Logout functionality
- **Phase 3: Core workflow - Search + Check-in + Create Household**
  - `EligibilityService` class for checking monthly service eligibility rules
  - `HouseholdRepository.SearchByName()` method for partial, case-insensitive name search
  - `ServiceEventRepository.GetLastCompletedByHouseholdId()` method to retrieve most recent completed service
  - `CheckInForm` - Main check-in screen replacing Form1
    - Large search textbox with real-time results
    - DataGridView displaying household details: Name, City/Zip, Size breakdown, Last service, Eligibility status, Active/Inactive status
    - Complete Service button with eligibility checking and pantry day detection
    - New Household button
    - Open Profile button (placeholder for Phase 4)
  - `OverrideReasonForm` modal dialog for ineligible households
    - Required reason dropdown (Special Circumstance, Emergency Need, Admin Override, Other)
    - Optional notes field
  - `NewHouseholdForm` for creating new households
    - Required fields: PrimaryName, at least one person (Children/Adults/Seniors)
    - Optional fields: Address, City, State, Zip, Phone, Email, Notes
    - Validation with clear error messages
  - Monthly eligibility checking: households can only be served once per calendar month
  - Automatic event type classification: PantryDay if today matches active pantry day, else Appointment
  - Search results update immediately after service completion or household creation
- **Phase 4: Household Profile + Service History + Appointments**
  - `ServiceEventRepository.Update()` method for updating service event status and details
  - `HouseholdProfileForm` with tabbed interface (Profile, Service History, Appointments)
  - Profile tab: Full household CRUD with all fields including Active toggle and auto-calculated total size
  - Service History tab: DataGridView displaying all service events with Status and Type filters
  - Appointments tab: Schedule new appointments with required date and text, optional notes
  - Context menu actions on Service History: Mark Scheduled appointments as Completed/Cancelled/NoShow
  - Completed appointments trigger eligibility check and override modal (same as direct check-in)
  - Cancelled/NoShow appointments do NOT affect monthly eligibility
  - CheckInForm "Open Profile" button now opens HouseholdProfileForm and refreshes results on save
- **Phase 5: Pantry day calendar generator + editor**
  - `PantryDaysForm` - Admin-only form for managing pantry day calendar
  - Year generation feature with configurable year input (defaults to current year)
  - Automatic pantry day generation following business rules:
    - January-October: 2nd, 3rd, and 4th Wednesday of each month
    - November-December: 1st, 2nd, and 3rd Wednesday of each month
  - `GetNthWeekdayOfMonth()` helper method for calculating nth occurrence of weekday in month
  - Duplicate prevention: skips dates that already have pantry days
  - DataGridView listing all pantry days with Date, Active status, and Notes columns
  - Edit functionality: change date, toggle active/inactive status, edit notes
  - Date validation prevents duplicate pantry days when editing
  - "Pantry Days" menu item added to Admin menu in CheckInForm and Form1
  - Check-in integration already implemented: CheckInForm uses pantry day matching by date
- **Phase 6: Stats dashboard + Monthly Summary Report (PDF + Print)**
  - Statistics data models: `MonthlyStatistics`, `CityBreakdown`, `OverrideBreakdown`, `PantryDayBreakdown`
  - Parameterized SQL queries in `Sql.cs` for all statistics calculations (active households, total people, completed services, unique households served, city breakdown, override breakdown, pantry day breakdown, composition served)
  - `StatisticsService` class with methods for current month stats, monthly stats, city breakdown, override breakdown, pantry day breakdown, and composition served
  - `StatsForm` - Statistics dashboard displaying current month metrics
    - Total active households, total people, completed services, unique households served
    - PantryDay vs Appointment completions breakdown
    - Overrides count and breakdown by reason
    - City breakdown (Winlock/Vader/Ryderwood) with households served and services completed
    - Refresh button to reload statistics
    - Monthly Summary button to open report form
  - `MonthlySummaryForm` - Monthly summary report viewer with month/year picker
    - Preview area showing formatted report text
    - Export PDF button with SaveFileDialog
    - Print button (generates PDF and opens print dialog via Windows default PDF handler)
  - `ReportService` class for PDF generation using QuestPDF library
    - Formatted monthly summary PDF with header, totals section, pantry day breakdown table, household composition section, area breakdown table, and footer
    - Professional formatting with tables, proper spacing, and clear sections
  - QuestPDF library (MIT License) added to PantryDeskCore for PDF generation
  - "Reports" menu added to CheckInForm with "Statistics Dashboard" and "Monthly Summary" items
  - Print functionality uses PDF format for consistent output (matches exported PDF exactly)
- **Phase 7: Backup / Export / Restore**
  - `BackupService` class for creating and restoring encrypted database backups
    - AES-256 encryption with key derived from app data root (deterministic, app-specific)
    - Backup files contain database and metadata JSON (backup date, schema version, app version)
    - Automatic daily backup check on first app run each day (stored in `Backups\` folder)
    - Manual "Backup Now" functionality
    - "Backup to USB" option with folder selection dialog
    - One-click restore with backup file validation and safety copy of current database
    - Backup date tracking via config table (`last_backup_date`)
  - `ExportService` class for data export functionality
    - CSV export: Excel-compatible format (UTF-8 with BOM) for households, service_events, pantry_days
    - JSON export: Structured export with all data in single file
    - Proper CSV escaping for fields containing commas, quotes, or newlines
  - `ServiceEventRepository.GetAll()` method added for export functionality
  - `BackupRestoreForm` - Admin-only form for restoring from backup
    - File selection dialog with .zip filter
    - Backup validation (checks for database file and metadata)
    - Confirmation dialog showing backup date and schema version
    - Safety copy creation before restore (`pantrydesk.db.pre_restore_*.backup`)
    - Restart prompt after successful restore
  - `ExportForm` - Admin-only form for data export
    - Radio buttons for CSV or JSON export format
    - Folder browser for CSV (creates 3 files) or file save dialog for JSON
    - Success messages showing file locations
  - Admin menu items added to CheckInForm:
    - "Backup Now" - Creates immediate backup
    - "Backup to USB..." - Backup to user-selected folder
    - "Restore from Backup..." - Opens restore form
    - "Export Data..." - Opens export form
  - All backup/restore/export features enforce Admin-only access via `PermissionChecker.RequireAdmin()`
  - Automatic backup runs silently on app startup if no backup exists for today
- **Phase 8: Seeder tool**
  - `SeederConfig` class for configuration management with command-line argument parsing
  - `DataGenerators` helper class for generating realistic names, addresses (no PO boxes), phones (360-555-XXXX format), emails, and weighted random selection
  - `HouseholdGenerator` class for generating households with realism guardrails (no child-only households, city/age distribution, size distribution)
  - `PantryDayGenerator` class for generating pantry days using Jan-Oct/Nov-Dec Wednesday logic (duplicated from PantryDaysForm)
  - `ServiceEventGenerator` class for generating completed PantryDay/Appointment events, scheduled appointments, and overrides with reasons
  - `AuthRoleSeeder` class for seeding Entry and Admin roles with default passwords ("entry" and "admin")
  - `DatabaseSeeder` orchestrator class coordinating all generation steps with database creation and migrations
  - Command-line interface with options: `--households`, `--months-back`, `--seed`, `--output`, `--help`
  - Deterministic generation support via RNG seed parameter
  - Demo moments: ineligible households (already served this month), override reasons (Special Circumstance, Emergency Need, Admin Override, Other), scheduled appointments in future
  - All constraints enforced: service area cities only (Winlock/Vader/Ryderwood), correct zip codes, no PO boxes, no child-only households
  - Seeder configuration stored as JSON in config table for traceability
  - Summary output showing counts of households, pantry days, service events, completed/scheduled events, and overrides
- **Phase 9: Demo polish + hardening**
  - Duplicate household warning when creating new households with similar names
  - Inactive household warning when completing service for inactive households
  - Demo mode configuration via `PantryDesk.demo.config` file
  - `AppConfig.GetDemoDatabasePath()` method to read demo database path from config file
  - `DatabaseManager` updated to check for demo config before using default database location
  - `publish.ps1` script for creating standalone executables and demo distribution package
  - Improved seeder logic: strict one pantry day per household per month, 1-2% override rate for appointments only
  - Seeder now filters pantry days to only generate those within the requested date range
  - Seeder summary now separates PantryDay events from Appointment events
  - Application icon support: executable icon and form icons for all windows (title bar and taskbar)
- **Phase 10: Statistics Dashboard Redesign**
  - Unified Statistics Dashboard with date range selector replacing separate Statistics and Monthly Summary forms
  - Date range presets: This Month, Last Month, Past 3/6/12 Months, This Year, Last Year, Custom Range
  - Summary cards displaying key metrics: Total Active Households, Total People, Completed Services, Unique Households Served
  - Interactive charts using OxyPlot.WindowsForms:
    - City Distribution (pie chart) - households served by city
    - Age Group Distribution (pie chart) - Children/Adults/Seniors composition
    - Monthly Visits Trend (line chart) - completed services by month with gridlines
    - Pantry Day Volume by Event (bar chart) - completed services per pantry day
  - Hover tooltips on all charts showing detailed values
  - Colorblind-friendly color palette (ColorBrewer Set2)
  - Chart export to PNG for PDF embedding using OxyPlot.ImageSharp
  - PDF reports with embedded chart images organized by section
  - Export PDF and Print buttons respect selected date range
  - OxyPlot.WindowsForms and OxyPlot.ImageSharp NuGet packages added to PantryDeskApp
  - Extended `StatisticsService` with date range methods: `GetStatsForDateRange()`, `GetMonthlyVisitsTrend()`, `GetPantryDayVolumeByEvent()`
  - Updated `ReportService.GenerateStatisticsPdf()` to accept and embed chart images
  - New SQL queries in `Sql.cs` for monthly visits trend and pantry day volume by event
- **Annual Active-Status Reset** (COMPLETED: 2025-02-06, TODO: Client Requirements/Annual Active-Status Reset)
  - `ActiveStatusSyncService` derives household `IsActive` from last qualifying service date vs configurable reset date
  - Sync runs on every app launch; bulk UPDATE for efficient status reconciliation
  - Default reset date: Jan 1 each year; Admin-only "Active Status Reset Date..." settings form (month/day)
  - Household profile: Active status displayed read-only (toggle removed); status is system-managed only
  - Complete Service (CheckInForm and HouseholdProfileForm) sets `IsActive` = true when recording a qualifying service
  - `HouseholdRepository.SetIsActive()` for lightweight updates; config keys `active_status_reset_month` / `active_status_reset_day`
  - Seeder: households and events generated for all households; sync produces inactive households naturally from service dates
- **Per-Household Member Tracking (with Age-Group Calculation)** (COMPLETED: 2025-02-06, TODO: Client Requirements/Per-Household Member Tracking)
  - `household_members` table with migration from schema v1 to v2; backfill of existing households into members
  - `HouseholdMember` model: FirstName, LastName, Birthday (required), IsPrimary, optional Race, VeteranStatus, DisabledStatus
  - `AgeGroupHelper`: derives Infant (0-2), Child (2-18), Adult (18-55), Senior (55+) from birthday
  - `HouseholdMemberRepository` with full CRUD; `HouseholdRepository.SearchByMemberName()` for search by any member
  - `NewHouseholdForm` and `HouseholdProfileForm`: member list UI (Add/Edit/Remove/Set Primary) replacing count sliders
  - `MemberEditForm` for adding/editing individual members
  - Household Profile members table: Race, Veteran, Disabled columns; fills available width
  - Household Profile: form height 600px; controls anchor to fill window width
  - Check-in: Name (Primary), Members, Size (bold), Age(s) (I/C/A/S), Last Service, Eligibility, Status, City/Zip
  - Check-in: fixed column widths (grid AutoSizeColumnsMode.None); Members Fill with MinimumWidth 200px; tooltips for truncated cells
  - Statistics: composition from members' age groups (4 groups); StatsForm and ReportService updated
  - Export: household_members CSV and JSON
  - Seeder: generates members with birthdays from age-group distribution; Lewis County demographic weights (Race, Veteran, Disabled)
- **Complete Service Dialog Enhancements** (COMPLETED: 2025-02-07, TODO: Client Requirements/Complete Service Dialog Enhancements)
  - New CompleteServiceDialog: Visit Type (required) and Notes (optional)
  - Visit types: Shop with TEFAP, Shop, TEFAP Only, Deck Only
  - `visit_type` column added to `service_events` table (schema migration v2→v3)
  - Monthly eligibility rule: only "Shop with TEFAP" and "Shop" count toward 1 visit/month limit; "TEFAP Only" and "Deck Only" do not
  - CheckInForm Complete Service flow: dialog shown first, eligibility checked only for Shop/Shop with TEFAP
  - HouseholdProfileForm Mark Completed: same CompleteServiceDialog and eligibility rules when marking appointments
  - Seeder generates VisitType for completed events; scheduled events leave VisitType null
  - Export CSV and JSON include VisitType
  - Type and Last Service columns display EventType - VisitType format (e.g. "PantryDay - Shop with TEFAP"); fallback to EventType when VisitType is null
  - Column widths: Last Service 320px, Service History Type 190px/Date 80px/Status 80px (more room for Notes)
- **Role Management, Check-In Layout & Backup UX** (COMPLETED: 2026-02-07, TODO: Phase 10 — UX Improvements & Workflow Enhancements/Role Management, Check-In Layout & Backup UX)
  - "Switch Role" replaces Logout: returns to Login dialog without exiting app; role and Admin menu/status bar refresh on success
  - Check-In: search and action buttons (Complete Service, New Household, Open Profile) on one row; "Search Name:" label removed, placeholder only
  - Status bar on Check-In: current role (left), Last Auto Backup and Last Manual Backup dates (right), Segoe UI 12pt bold; updates on role switch and after backup
  - BackupRestoreForm: read-only panel at top with database path, Last Auto Backup, Last Manual Backup (YYYY-MM-DD or "No backup yet")
  - Separate config keys for last auto vs last manual backup date; automatic daily backup and Backup to USB update the correct one
  - Backup to USB: fixed for in-use DB (temp DB read into memory while connection open, then zipped); rotation keeps max 8 backups per folder and deletes matching `.zip.meta.json` with each removed zip
  - Weekly manual-backup reminder on launch (7+ days): dialog with Snooze and Backup Now (Admin opens Backup to USB; Entry sees disabled button and note to log in as Admin)
  - "Backup Now" menu item removed (automatic backup still runs once per day on first launch)

### Changed

- Statistics Dashboard now supports flexible date ranges instead of fixed monthly view
- Monthly Summary functionality merged into unified Statistics Dashboard
- PDF reports now include actual chart images instead of simple bar representations
- Charts are organized into their respective sections in PDF (City Breakdown, Household Composition, Pantry Day Breakdown, Monthly Visits Trend)
- PantryDeskSeeder now generates full demo database with realistic data (replaces "Hello seed" placeholder)
- Application now requires authentication on every launch
- Form1 test button updated to handle existing pantry days (prevents UNIQUE constraint violations)
- Main application now shows CheckInForm instead of Form1 after login
- Program.cs updated to launch CheckInForm as the main screen
- CheckInForm "Open Profile" button now opens functional HouseholdProfileForm (replaces placeholder)
- Removed unused Form1.cs and Form1.Designer.cs files (replaced by CheckInForm in Phase 3)
- Seeder default household count increased from 150 to 300
- Seeder override logic improved: pantry days never have overrides, appointments have 1-2% override rate
- Seeder now only generates pantry days within the requested date range (not full years)
- Check-in UX: eligibility column shows icon badges (✅ Eligible / ❌ Already Served) with color coding; search by name debounced 250ms with Enter for immediate search; reduced column widths (Eligibility, Name Primary, City/Zip) (COMPLETED: 2025-02-07, TODO: Phase 10 — UX Improvements & Workflow Enhancements/Search & Check-In Improvements)
- Seeder CLI: validate unknown command-line arguments (clear error and non-zero exit); print effective configuration summary before seeding (households, months back, output path, seed); distinguish "Missing value for --option" from "Unknown argument" for options that require a value (COMPLETED: 2025-02-07, TODO: Seeder CLI Improvements)

### Removed

- `MonthlySummaryForm` - functionality merged into `StatsForm`
- "Monthly Summary" menu item - replaced by unified Statistics Dashboard

### Fixed

- Solution verified to build and run from clean clone
- PantryDeskApp opens blank window as expected
- Fixed transaction handling in `DatabaseMigrator.TableExists` method
- Fixed Phase 1 test button to check for existing pantry days before creating (prevents duplicate date errors)
- Fixed seeder generating overrides on pantry day events (now only appointments can have overrides)
- Fixed seeder generating too many pantry days (now filters to requested date range)
- Fixed seeder override rate being too high (reduced to 1-2% of appointments only)
