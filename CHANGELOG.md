# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Added

- Initial repository scaffolding
- .NET solution skeleton with PantryDeskApp, PantryDeskCore, and PantryDeskSeeder projects
- Repository documentation (README.md, TODO.md, CHANGELOG.md, LICENSE.md)
- .gitignore for .NET/Visual Studio
- `.editorconfig` for consistent C# code formatting
- `AppConfig` class in PantryDeskCore for data folder configuration (defaults to `C:\ProgramData\PantryDesk\`)
- **Phase 1: Database schema and data access layer**
  - SQLite database schema with 5 tables: `config`, `households`, `service_events`, `pantry_days`, `auth_roles`
  - Database migration system with schema version tracking (currently version 1)
  - `DatabaseManager` for connection management and database initialization
  - `DatabaseMigrator` for schema creation and version management
  - Data models: `Household`, `ServiceEvent`, `PantryDay`, `AuthRole`
  - Repository classes with full CRUD operations:
    - `HouseholdRepository` - Create, read, update, soft delete
    - `ServiceEventRepository` - Create and query methods
    - `PantryDayRepository` - Full CRUD operations
    - `AuthRoleRepository` - Role authentication with password hashing
    - `ConfigRepository` - Schema version and app version management
  - `PasswordHasher` using PBKDF2 with 100,000 iterations for secure password storage
  - All SQL queries use parameterized statements (SQL injection protection)
  - Centralized SQL statements in `Sql.cs` class
  - Phase 1 verification test button in PantryDeskApp
- **Phase 2: Authentication (Entry/Admin)**
  - `SessionManager` class for tracking current logged-in role
  - `PermissionChecker` helper class for Admin-only feature enforcement
  - `AuthRoleRepository.HasAnyRoles()` method to check if roles exist in database
  - `InitialSetupForm` for first-time password configuration (Entry and Admin roles)
    - Password validation (minimum 8 characters, confirmation required)
    - Warning if Entry and Admin passwords are identical
    - Stores passwords as salted hashes (no default passwords)
  - `LoginForm` for user authentication with role selection
    - Role dropdown (Entry/Admin)
    - Password verification using existing `AuthRoleRepository`
    - Error handling for invalid credentials
  - `ChangePasswordForm` for Admin to change role passwords
    - Requires current password verification
    - Validates new password (8+ characters, confirmation match)
    - Prevents reusing current password
    - Success/error feedback
  - Application startup flow: Initial Setup → Login → Main Form
  - Form1 updated with Admin menu (visible only to Admin users)
  - Form1 title displays current logged-in role
  - Logout functionality
- **Phase 3: Core workflow - Search + Check-in + Create Household**
  - `EligibilityService` class for checking monthly service eligibility rules
  - `HouseholdRepository.SearchByName()` method for partial, case-insensitive name search
  - `ServiceEventRepository.GetLastCompletedByHouseholdId()` method to retrieve most recent completed service
  - `CheckInForm` - Main check-in screen replacing Form1
    - Large search textbox with real-time results
    - DataGridView displaying household details: Name, City/Zip, Size breakdown, Last service, Eligibility status, Active/Inactive status
    - Complete Service button with eligibility checking and pantry day detection
    - New Household button
    - Open Profile button (placeholder for Phase 4)
  - `OverrideReasonForm` modal dialog for ineligible households
    - Required reason dropdown (Special Circumstance, Emergency Need, Admin Override, Other)
    - Optional notes field
  - `NewHouseholdForm` for creating new households
    - Required fields: PrimaryName, at least one person (Children/Adults/Seniors)
    - Optional fields: Address, City, State, Zip, Phone, Email, Notes
    - Validation with clear error messages
  - Monthly eligibility checking: households can only be served once per calendar month
  - Automatic event type classification: PantryDay if today matches active pantry day, else Appointment
  - Search results update immediately after service completion or household creation
- **Phase 4: Household Profile + Service History + Appointments**
  - `ServiceEventRepository.Update()` method for updating service event status and details
  - `HouseholdProfileForm` with tabbed interface (Profile, Service History, Appointments)
  - Profile tab: Full household CRUD with all fields including Active toggle and auto-calculated total size
  - Service History tab: DataGridView displaying all service events with Status and Type filters
  - Appointments tab: Schedule new appointments with required date and text, optional notes
  - Context menu actions on Service History: Mark Scheduled appointments as Completed/Cancelled/NoShow
  - Completed appointments trigger eligibility check and override modal (same as direct check-in)
  - Cancelled/NoShow appointments do NOT affect monthly eligibility
  - CheckInForm "Open Profile" button now opens HouseholdProfileForm and refreshes results on save
- **Phase 5: Pantry day calendar generator + editor**
  - `PantryDaysForm` - Admin-only form for managing pantry day calendar
  - Year generation feature with configurable year input (defaults to current year)
  - Automatic pantry day generation following business rules:
    - January-October: 2nd, 3rd, and 4th Wednesday of each month
    - November-December: 1st, 2nd, and 3rd Wednesday of each month
  - `GetNthWeekdayOfMonth()` helper method for calculating nth occurrence of weekday in month
  - Duplicate prevention: skips dates that already have pantry days
  - DataGridView listing all pantry days with Date, Active status, and Notes columns
  - Edit functionality: change date, toggle active/inactive status, edit notes
  - Date validation prevents duplicate pantry days when editing
  - "Pantry Days" menu item added to Admin menu in CheckInForm and Form1
  - Check-in integration already implemented: CheckInForm uses pantry day matching by date
- **Phase 6: Stats dashboard + Monthly Summary Report (PDF + Print)**
  - Statistics data models: `MonthlyStatistics`, `CityBreakdown`, `OverrideBreakdown`, `PantryDayBreakdown`
  - Parameterized SQL queries in `Sql.cs` for all statistics calculations (active households, total people, completed services, unique households served, city breakdown, override breakdown, pantry day breakdown, composition served)
  - `StatisticsService` class with methods for current month stats, monthly stats, city breakdown, override breakdown, pantry day breakdown, and composition served
  - `StatsForm` - Statistics dashboard displaying current month metrics
    - Total active households, total people, completed services, unique households served
    - PantryDay vs Appointment completions breakdown
    - Overrides count and breakdown by reason
    - City breakdown (Winlock/Vader/Ryderwood) with households served and services completed
    - Refresh button to reload statistics
    - Monthly Summary button to open report form
  - `MonthlySummaryForm` - Monthly summary report viewer with month/year picker
    - Preview area showing formatted report text
    - Export PDF button with SaveFileDialog
    - Print button (generates PDF and opens print dialog via Windows default PDF handler)
  - `ReportService` class for PDF generation using QuestPDF library
    - Formatted monthly summary PDF with header, totals section, pantry day breakdown table, household composition section, area breakdown table, and footer
    - Professional formatting with tables, proper spacing, and clear sections
  - QuestPDF library (MIT License) added to PantryDeskCore for PDF generation
  - "Reports" menu added to CheckInForm with "Statistics Dashboard" and "Monthly Summary" items
  - Print functionality uses PDF format for consistent output (matches exported PDF exactly)
- **Phase 7: Backup / Export / Restore**
  - `BackupService` class for creating and restoring encrypted database backups
    - AES-256 encryption with key derived from app data root (deterministic, app-specific)
    - Backup files contain database and metadata JSON (backup date, schema version, app version)
    - Automatic daily backup check on first app run each day (stored in `Backups\` folder)
    - Manual "Backup Now" functionality
    - "Backup to USB" option with folder selection dialog
    - One-click restore with backup file validation and safety copy of current database
    - Backup date tracking via config table (`last_backup_date`)
  - `ExportService` class for data export functionality
    - CSV export: Excel-compatible format (UTF-8 with BOM) for households, service_events, pantry_days
    - JSON export: Structured export with all data in single file
    - Proper CSV escaping for fields containing commas, quotes, or newlines
  - `ServiceEventRepository.GetAll()` method added for export functionality
  - `BackupRestoreForm` - Admin-only form for restoring from backup
    - File selection dialog with .zip filter
    - Backup validation (checks for database file and metadata)
    - Confirmation dialog showing backup date and schema version
    - Safety copy creation before restore (`pantrydesk.db.pre_restore_*.backup`)
    - Restart prompt after successful restore
  - `ExportForm` - Admin-only form for data export
    - Radio buttons for CSV or JSON export format
    - Folder browser for CSV (creates 3 files) or file save dialog for JSON
    - Success messages showing file locations
  - Admin menu items added to CheckInForm:
    - "Backup Now" - Creates immediate backup
    - "Backup to USB..." - Backup to user-selected folder
    - "Restore from Backup..." - Opens restore form
    - "Export Data..." - Opens export form
  - All backup/restore/export features enforce Admin-only access via `PermissionChecker.RequireAdmin()`
  - Automatic backup runs silently on app startup if no backup exists for today
- **Phase 8: Seeder tool**
  - `SeederConfig` class for configuration management with command-line argument parsing
  - `DataGenerators` helper class for generating realistic names, addresses (no PO boxes), phones (360-555-XXXX format), emails, and weighted random selection
  - `HouseholdGenerator` class for generating households with realism guardrails (no child-only households, city/age distribution, size distribution)
  - `PantryDayGenerator` class for generating pantry days using Jan-Oct/Nov-Dec Wednesday logic (duplicated from PantryDaysForm)
  - `ServiceEventGenerator` class for generating completed PantryDay/Appointment events, scheduled appointments, and overrides with reasons
  - `AuthRoleSeeder` class for seeding Entry and Admin roles with default passwords ("entry" and "admin")
  - `DatabaseSeeder` orchestrator class coordinating all generation steps with database creation and migrations
  - Command-line interface with options: `--households`, `--months-back`, `--seed`, `--output`, `--help`
  - Deterministic generation support via RNG seed parameter
  - Demo moments: ineligible households (already served this month), override reasons (Special Circumstance, Emergency Need, Admin Override, Other), scheduled appointments in future
  - All constraints enforced: service area cities only (Winlock/Vader/Ryderwood), correct zip codes, no PO boxes, no child-only households
  - Seeder configuration stored as JSON in config table for traceability
  - Summary output showing counts of households, pantry days, service events, completed/scheduled events, and overrides

### Changed

- PantryDeskSeeder now generates full demo database with realistic data (replaces "Hello seed" placeholder)
- Application now requires authentication on every launch
- Form1 test button updated to handle existing pantry days (prevents UNIQUE constraint violations)
- Main application now shows CheckInForm instead of Form1 after login
- Program.cs updated to launch CheckInForm as the main screen
- CheckInForm "Open Profile" button now opens functional HouseholdProfileForm (replaces placeholder)
- Removed unused Form1.cs and Form1.Designer.cs files (replaced by CheckInForm in Phase 3)

### Fixed

- Solution verified to build and run from clean clone
- PantryDeskApp opens blank window as expected
- Fixed transaction handling in `DatabaseMigrator.TableExists` method
- Fixed Phase 1 test button to check for existing pantry days before creating (prevents duplicate date errors)